<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üéß 8D Audio + Auto Tuner</title>
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(145deg, #111, #222);
      color: white;
      text-align: center;
      padding: 2rem;
    }
    input[type="range"] {
      width: 300px;
    }
    canvas {
      margin-top: 2rem;
      background: #111;
      border-radius: 10px;
    }
    button {
      margin: 1rem;
      padding: 10px 20px;
      background: #00bcd4;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #0097a7;
    }
  </style>
</head>
<body>

  <h1>üéß 8D Audio + Auto Tune üé∂</h1>

  <input type="file" id="audioFile" accept="audio/mp3" />
  <br><br>

  <label>Bass</label><br>
  <input type="range" id="bassSlider" min="0.5" max="2" step="0.01" value="1"><br>

  <label>Mid</label><br>
  <input type="range" id="midSlider" min="0.5" max="2" step="0.01" value="1"><br>

  <label>Treble</label><br>
  <input type="range" id="trebleSlider" min="0.5" max="2" step="0.01" value="1"><br><br>

  <button id="toggle8D">üîÅ 8D Audio: ON</button>

  <canvas id="visualizer" width="600" height="150"></canvas>

  <script>
    const audioFile = document.getElementById('audioFile');
    const bassSlider = document.getElementById('bassSlider');
    const midSlider = document.getElementById('midSlider');
    const trebleSlider = document.getElementById('trebleSlider');
    const toggle8D = document.getElementById('toggle8D');

    let audioContext, source, analyser;
    let bassFilter, midFilter, trebleFilter, panner;
    let is8DActive = true;
    let autoTuneInterval;
    let panAngle = 0;

    audioFile.addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        if (audioContext) audioContext.close();

        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        audioContext.decodeAudioData(e.target.result, function (buffer) {
          source = audioContext.createBufferSource();
          source.buffer = buffer;

          bassFilter = audioContext.createBiquadFilter();
          bassFilter.type = 'lowshelf';
          bassFilter.frequency.value = 200;

          midFilter = audioContext.createBiquadFilter();
          midFilter.type = 'peaking';
          midFilter.frequency.value = 1000;
          midFilter.Q.value = 1;

          trebleFilter = audioContext.createBiquadFilter();
          trebleFilter.type = 'highshelf';
          trebleFilter.frequency.value = 3000;

          panner = audioContext.createStereoPanner();

          analyser = audioContext.createAnalyser();
          analyser.fftSize = 2048;

          source.connect(bassFilter);
          bassFilter.connect(midFilter);
          midFilter.connect(trebleFilter);
          trebleFilter.connect(panner);
          panner.connect(analyser);
          analyser.connect(audioContext.destination);

          source.start(0);
          updateFilters();
          visualize();
          loopPanning();
          startAutoTune();
        });
      };
      reader.readAsArrayBuffer(file);
    });

    function updateFilters() {
      bassFilter.gain.value = parseFloat(bassSlider.value);
      midFilter.gain.value = parseFloat(midSlider.value);
      trebleFilter.gain.value = parseFloat(trebleSlider.value);
    }

    bassSlider.addEventListener('input', updateFilters);
    midSlider.addEventListener('input', updateFilters);
    trebleSlider.addEventListener('input', updateFilters);

    function visualize() {
      const canvas = document.getElementById('visualizer');
      const ctx = canvas.getContext('2d');
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function draw() {
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);

        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const barWidth = (canvas.width / bufferLength) * 2.5;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const barHeight = dataArray[i] / 2;
          ctx.fillStyle = `rgb(${barHeight + 100},50,200)`;
          ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
          x += barWidth + 1;
        }
      }
      draw();
    }

    function loopPanning() {
      function panLoop() {
        if (is8DActive) {
          panAngle += 0.01;
          panner.pan.value = Math.sin(panAngle);
        } else {
          panner.pan.value = 0;
        }
        requestAnimationFrame(panLoop);
      }
      panLoop();
    }

    toggle8D.addEventListener('click', () => {
      is8DActive = !is8DActive;
      toggle8D.textContent = `üîÅ 8D Audio: ${is8DActive ? 'ON' : 'OFF'}`;
    });

    function startAutoTune() {
      if (autoTuneInterval) clearInterval(autoTuneInterval);
      autoTuneInterval = setInterval(() => {
        const freqData = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(freqData);

        const bassRange = freqData.slice(0, 100);
        const midRange = freqData.slice(100, 1000);
        const trebleRange = freqData.slice(1000);

        const avg = arr => arr.reduce((a, b) => a + b, 0) / arr.length;

        const bassAvg = avg(bassRange);
        const midAvg = avg(midRange);
        const trebleAvg = avg(trebleRange);

        const bassBoost = Math.min(2, Math.max(0.8, 1.5 - bassAvg / 128));
        const midBoost = Math.min(2, Math.max(0.7, 1.2 - midAvg / 256));
        const trebleBoost = Math.min(2, Math.max(0.7, 1.4 - trebleAvg / 256));

        bassSlider.value = bassBoost.toFixed(2);
        midSlider.value = midBoost.toFixed(2);
        trebleSlider.value = trebleBoost.toFixed(2);

        updateFilters();
      }, 800); // Update every 800ms
    }
  </script>
</body>
</html>
