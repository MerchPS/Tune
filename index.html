<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>8D Audio Tuner üéß</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: linear-gradient(145deg, #121212, #1f1f1f);
      color: white;
      padding: 2rem;
    }
    input[type="range"] {
      width: 300px;
    }
    canvas {
      margin-top: 2rem;
      background: #222;
      border-radius: 10px;
    }
    button {
      margin: 1rem;
      padding: 0.8rem 1.5rem;
      background: #00bcd4;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #0097a7;
    }
  </style>
</head>
<body>

  <h1>üéß 8D Audio + Auto Tuning üé∂</h1>

  <input type="file" id="audioFile" accept="audio/mp3" />
  <br><br>

  <label>Bass</label><br>
  <input type="range" id="bassSlider" min="0.5" max="2" step="0.01" value="1"><br>

  <label>Mid</label><br>
  <input type="range" id="midSlider" min="0.5" max="2" step="0.01" value="1"><br>

  <label>Treble</label><br>
  <input type="range" id="trebleSlider" min="0.5" max="2" step="0.01" value="1"><br><br>

  <button id="autoTuneBtn">üéõÔ∏è Auto-Tune Lagu</button>

  <canvas id="visualizer" width="600" height="150"></canvas>

  <script>
    const audioFile = document.getElementById('audioFile');
    const bassSlider = document.getElementById('bassSlider');
    const midSlider = document.getElementById('midSlider');
    const trebleSlider = document.getElementById('trebleSlider');
    const autoTuneBtn = document.getElementById('autoTuneBtn');

    let audioContext, source, analyser;
    let bassFilter, midFilter, trebleFilter, panner;

    audioFile.addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        if (audioContext) audioContext.close(); // reset if already exists
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        audioContext.decodeAudioData(e.target.result, function (buffer) {
          source = audioContext.createBufferSource();
          source.buffer = buffer;

          // EQ filters
          bassFilter = audioContext.createBiquadFilter();
          bassFilter.type = 'lowshelf';
          bassFilter.frequency.value = 200;

          midFilter = audioContext.createBiquadFilter();
          midFilter.type = 'peaking';
          midFilter.frequency.value = 1000;
          midFilter.Q.value = 1;

          trebleFilter = audioContext.createBiquadFilter();
          trebleFilter.type = 'highshelf';
          trebleFilter.frequency.value = 3000;

          // 8D Effect (Auto Panning)
          panner = audioContext.createStereoPanner();

          // Visualizer
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 2048;

          // Connect nodes
          source.connect(bassFilter);
          bassFilter.connect(midFilter);
          midFilter.connect(trebleFilter);
          trebleFilter.connect(panner);
          panner.connect(analyser);
          analyser.connect(audioContext.destination);

          source.start(0);
          updateFilters();
          visualize();
          animatePanning();
        });
      };
      reader.readAsArrayBuffer(file);
    });

    function updateFilters() {
      bassFilter.gain.value = parseFloat(bassSlider.value);
      midFilter.gain.value = parseFloat(midSlider.value);
      trebleFilter.gain.value = parseFloat(trebleSlider.value);
    }

    bassSlider.addEventListener('input', updateFilters);
    midSlider.addEventListener('input', updateFilters);
    trebleSlider.addEventListener('input', updateFilters);

    function visualize() {
      const canvas = document.getElementById('visualizer');
      const ctx = canvas.getContext('2d');
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function draw() {
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);

        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const barWidth = (canvas.width / bufferLength) * 2.5;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          const barHeight = dataArray[i] / 2;
          ctx.fillStyle = `rgb(${barHeight + 100},50,200)`;
          ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
          x += barWidth + 1;
        }
      }
      draw();
    }

    function animatePanning() {
      let angle = 0;
      function panLoop() {
        angle += 0.01;
        panner.pan.value = Math.sin(angle); // 8D sound effect
        requestAnimationFrame(panLoop);
      }
      panLoop();
    }

    autoTuneBtn.addEventListener('click', () => {
      if (!analyser) return;

      const freqData = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(freqData);

      const bassRange = freqData.slice(0, 100);
      const midRange = freqData.slice(100, 1000);
      const trebleRange = freqData.slice(1000);

      const avg = arr => arr.reduce((a, b) => a + b, 0) / arr.length;

      const bassAvg = avg(bassRange);
      const midAvg = avg(midRange);
      const trebleAvg = avg(trebleRange);

      const bassBoost = Math.min(2, Math.max(0.8, 1.5 - bassAvg / 128));
      const midBoost = Math.min(2, Math.max(0.7, 1.2 - midAvg / 256));
      const trebleBoost = Math.min(2, Math.max(0.7, 1.4 - trebleAvg / 256));

      bassSlider.value = bassBoost.toFixed(2);
      midSlider.value = midBoost.toFixed(2);
      trebleSlider.value = trebleBoost.toFixed(2);

      updateFilters();

      alert("‚úÖ Lagu sudah di-tuning otomatis!");
    });
  </script>
</body>
</html>
